name: Go

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-latest
    environment: production_environment
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.16

    - name: Test
      run: go test -v ./...
    - name: Docker Auth
      run: docker login -u "${{secrets.U}}" -p "${{secrets.P}}" docker.io
    - name: Build Image
      run: docker build . --tag "pbaba11/amebo:latest" --build-arg MY_ID="${{secrets.MY_ID}}" --build-arg STUB_TWEET="${{secrets.STUB_TWEET}}" --build-arg API_KEY="${{secrets.API_KEY}}" --build-arg API_SECRET_KEY="${{secrets.API_SECRET_KEY}}" --build-arg ACCESS_TOKEN="${{secrets.ACCESS_TOKEN}}" --build-arg ACCESS_TOKEN_SECRET="${{secrets.ACCESS_TOKEN_SECRET}}" --build-arg BEARER_TOKEN="${{secrets.BEARER_TOKEN}}" 
    - name: push to docker hub
      run: docker push pbaba11/amebo:latest
    - name: Download ECS CLI
      run: curl -Lo /usr/local/bin/ecs-cli https://amazon-ecs-cli.s3.amazonaws.com/ecs-cli-linux-amd64-latest && chmod +x /usr/local/bin/ecs-cli
    - name: Configure ECS CLI
      run: ecs-cli configure --cluster amebo --default-launch-type FARGATE --config-name amebo --region us-east-2 && ecs-cli configure profile --access-key {{secrets.ACCESS_KEY_ID}} --secret-key {{secrets.SECRET_ACCESS_KEY}} --profile-name amebo-profile
    - name: Deploy to ECS
      run: ecs-cli compose --project-name amebo service up --ecs-profile amebo-profile